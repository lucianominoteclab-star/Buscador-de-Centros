<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Centros Cercanos</title>
<style>
 body { font-family: Arial, sans-serif; padding: 20px; }
 input, button { padding: 8px; font-size: 16px; }
 #map { width: 100%; height: 400px; margin-top: 20px; border: 1px solid #ccc; }
 .resultado { margin-top: 20px; padding: 10px; background: #f4f4f4; border-radius: 5px; }
</style>
</head>
<body>
<h2>Buscar Centros Cercanos por Tiempo de Viaje</h2>
<p>Ingres치 la direcci칩n del interesado:</p>
<input id="origen" type="text" placeholder="Ej: Av. Rivadavia 1000, CABA" style="width: 80%;" />
<button onclick="buscarCentros()">Buscar</button>

<div id="resultados"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
// --- Centros cargados (queda como base "fija") ---
const centros = [
  { nombre: "CAU San Miguel", direccion: "Av. Le칩n Gallardo 207, San Miguel, Buenos Aires", coords: [-34.54357, -58.71262] },
  { nombre: "CAU Don Torcuato", direccion: "Av. 츼ngel T. de Alvear 2555, Don Torcuato", coords: [-34.48741, -58.63095] },
  { nombre: "CAU Hurlingham", direccion: "Arturo Jauretche 1435, Hurlingham", coords: [-34.59072, -58.63814] },
  { nombre: "CAU Ca침uelas", direccion: "Libertad 1200, Ca침uelas", coords: [-35.04862, -58.75647] },
  { nombre: "CAU San Mart칤n", direccion: "Sarmiento 1887, San Mart칤n", coords: [-34.57439, -58.54025] },
  { nombre: "CAU Parque Leloir", direccion: "Mart칤n Fierro 3246, Parque Leloir", coords: [-34.62980, -58.68783] },
  { nombre: "CAU Munro", direccion: "V칠lez S치rsfield 4898, Munro", coords: [-34.52889, -58.51089] },
  { nombre: "CAU Merlo", direccion: "Avellaneda 673, Merlo", coords: [-34.66641, -58.73152] },
  { nombre: "CAU Banfield", direccion: "Vieytes 211, Banfield", coords: [-34.74609, -58.39254] }
];

// --- Map Init ---
let map = L.map('map').setView([-34.60, -58.45], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let rutaLayer;

// --- Geocodificaci칩n usando Nominatim (gratuito) ---
async function geocode(address) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.length === 0) return null;
  return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
}

// --- Tiempo de viaje con OSRM (gratuito) ---
async function tiempoRuta(origen, destino) {
  const url = `https://router.project-osrm.org/route/v1/driving/${origen[1]},${origen[0]};${destino[1]},${destino[0]}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.routes || data.routes.length === 0) return null;
  return data.routes[0];
}

async function buscarCentros() {
  const direccion = document.getElementById('origen').value.trim();
  if (!direccion) return alert("Ingres치 una direcci칩n");

  document.getElementById('resultados').innerHTML = "Calculando...";

  const coordOrigen = await geocode(direccion);
  if (!coordOrigen) {
    document.getElementById('resultados').innerHTML = "Direcci칩n no encontrada.";
    return;
  }

  let resultados = [];

  for (let c of centros) {
    const ruta = await tiempoRuta(coordOrigen, c.coords);
    if (ruta) {
      resultados.push({
        nombre: c.nombre,
        direccion: c.direccion,
        coords: c.coords,
        tiempo: ruta.duration / 60,
        distancia: ruta.distance / 1000,
        geometry: ruta.geometry
      });
    }
  }

  resultados.sort((a, b) => a.tiempo - b.tiempo);

  const top2 = resultados.slice(0, 2);

  let html = `<h3>Los 2 centros con MEJOR tiempo de viaje:</h3>`;
  top2.forEach(r => {
    html += `<div class='resultado'>
      <b>${r.nombre}</b><br>
      ${r.direccion}<br>
      游 Tiempo aprox: ${r.tiempo.toFixed(1)} min<br>
      游늸 Distancia: ${r.distancia.toFixed(1)} km
    </div>`;
  });

  document.getElementById('resultados').innerHTML = html;

  if (rutaLayer) map.removeLayer(rutaLayer);

  rutaLayer = L.layerGroup().addTo(map);

  top2.forEach(r => {
    L.geoJSON(r.geometry, { color: 'blue' }).addTo(rutaLayer);
    L.marker(r.coords).addTo(rutaLayer).bindPopup(r.nombre);
  });

  L.marker(coordOrigen).addTo(rutaLayer).bindPopup("Origen");

  map.fitBounds(rutaLayer.getBounds());
}
</script>
</body>
</html>
